---
title: MySQL必知必会15-20章
date: 2020-08-17 14:23:53
tags:
  - MySQL
  - MYSQL必知必会
---

这些章讲解联结表，组合查询，全文本搜索，插入数据，更新和删除数据。

<!--more-->

## 第十八掌，全文本搜索

### 18.1.理解全文本搜素

**并非所有引擎都支持全文本搜索：两个最常见引擎为MyISAM和InnoDB。前者支持全文本搜索，而后者不支持。**

第八章介绍了LIKE关键字，它利用通配操作符匹配文本(和部分文本)。利用LIKE，能够查找包含特殊值或部分值的行(不管这些值位于列内什么位置)。

第九章中，用基于文本的搜索作为正则表达式匹配列值的更近一步的介绍。使用正则表达式，可以编写查找所需行的非常复杂的匹配模式。

虽然这些搜索机制非常有用，但存在几个重要的限制。

1.性能--通配符和正则表达式匹配通常要求MySQL尝试匹配表中所有行(而且这些搜索极少使用表索引)。因此，由于被搜索行数不断增加，这些搜索可能非常耗时。

2.明确控制----使用通配符和正则表达式匹配，很难(而且并不总是能)明确地控制匹配什么和不匹配什么。例如，指定一个词必须匹配，一个词必须不匹配，而一个词仅在第一个词确实匹配的情况下可以匹配或者才可以不匹配。

3.智能化的结果---虽然基于通配符和正则表达式的搜索结果的方法。例如，一个特殊词的搜索将会返回包含该词的所有行，而不区分包含单个匹配的行和包括多个匹配的行(按照可能是更好的匹配来排列它们)。类似，一个特殊词的搜索将不会找出不包含该词但包含其他相关词的行。

所有这些限制以及更多的限制都可以用全文本搜来解决。

### 18.2.使用全文本搜索

为了进行全文本搜索，必须索引被搜索的列，而且要随着数据的改变不断地重新索引。在对表列进行适当设计后，MySQL会自动进行所有的索引和重新索引。在索引之后，SELECT可与Match()和Against()一起使用以解决实际问题。

#### 18.2.1.启用全文本搜索支持

一般在创建表时启动全文本搜索。CREATE TABLE语句接受FULLTEXT子句，它给出被索引的一个逗号分隔的列表。

下面的CREATE语句演示了FULLTEXT子句的使用。

```mysql
CREATE TABLE productnotes
(
 note_id     int         NOT NULL, AUTO_INCREMENT
 prod_id     char(10)    NOT NULL,
 note_date   datetime    NOT NULL,
 note_text   text        NULL,
 PRIMARY  KEY(note_id),
 FULLTEXT(note_text)
)ENGINE=MyISAM;
```

分析：这些列中有一个名为note_text的列，为了进行全文本搜索，MySQL根据子句FULLTEXT(note_text)的指示对它进行索引。这里的FULLTEXT索引单个列，如果需要也可以指定多个列。

在定义之后，MySQL自动维护该索引。在增加，更新或删除行时，索引随之自动更新。可以在创建表时指定FULLTEXT，或者在稍后指定(在这种情况下所有已有数据必须立即索引)。

不要在导入数据时使用FULLTEXT：更新索引要花时间，虽然不是很多，但毕竟要花时间。如果正在导入数据到一个新表，此时不应该启动FULLTEXT索引。应该首先导入所有数据，然后再修改表，定义FULLTEXT。这样有助于更快地导入数据(而且使索引数据的总时间小于在导入每行时分别进行索引所需的总时间)。

#### 18.2.2.进行全文本搜索

在索引之后，使用两个函数Match()和Against()执行全文本搜索，其中Match()指定被搜索的列，Against()指定要使用的搜索表达式。

下面举一个例子：

```mysql
输入： SELECT note_text
      FROM productnotes
      WHERE Match(note_text) Against('rabbit');
```

输出：

| note_text              |
| ---------------------- |
| C-----------文本内容。 |

分析：此语句检索单个列note_text，由于WHERE子句，一个全文本搜索被执行。Match(note_text)指示MySQL针对指定的列进行搜索哦，Against('rabbit')指定rabbit作为搜索文本。由于有两行包含词rabbit，这两行被返回。

#### 18.2.3.使用查询扩展

查询扩展用来设法放宽所返回的全文本搜索结果的范围。考虑下面的情况。你想找出所有提到anvils的注释。只有一个注释包含词anvils。但你好像找出可能与你的搜索有关的所有其他行，即使它们不包含词anvils。这也是查询扩展的一项任务。在使用查询扩展时，MySQL对数据和索引进行两遍扫描来完成搜索。

1.首先，进行一个基本的全文本搜索，找出与搜索条件匹配的所有行。

2.其次，MySQL检查这些匹配行并选择所有有用的词(我们将会简单地解释MySQL如何断定什么有用，什么无用)。

3.再其次，MySQL再次进行全文本搜索，这次不仅使用原来的条件，而且还使用所有有用的词。

下面举个例子：

```mysql
输入： SELECT note_text
      FROM productnotes
      WHERE Match(note_text) Against('anvils' WITH QUERY EXPANSION);
```

输出：

| note_text     |
| ------------- |
| M----文本内容 |

分析：这次返回了7行。第一行包含词anvils，因此等级最高。第二行与anvils无关，但因为它包含第一行中的两个词(customer和recommend)，所以也被检索了出来。后面的行也如此。

#### 18.2.4.布尔文本搜索

以布尔方式，可以提供如下内容的细节。

1.要匹配的值。2.要排斥的词。3.排列提示。4.表达式分组。5.另外一些内容

即使没有FULLTEXT索引也可以使用：布尔方式不同于迄今为止使用的全文本搜索语法的地方在于，即使没有定义FULLTEXT索引，也可以使用它，但这是一种非常缓慢的操作(其性能将随着数据量的增加而降低)。

为演示IN BOOLEAN MOOE的作用，举一个简单的例子。

```mysql
输入： SELECT note_text
      FROM productnotes
      WHERE Match(note_text) Against('heavy -rope*' IN BOOLEAN MOOE);
```

输出：

| note_text         |
| ----------------- |
| C--------文本内容 |

分析：这次只返回一行。这一次匹配词heavy，但-rope*明确地指示MySQL排除包含rope*(任何以rope开始的词)，包括(ropes)的行。

我们已经看到了布尔操作符-和*。下面列出常见的几种操作符。

| 布尔操作符 | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| +          | 包含，词必须存在                                             |
| -          | 排除，词必须不出现                                           |
| >          | 包含，而且增加等级值                                         |
| <          | 包含，且减少等级值                                           |
| ()         | 把词组成子表达式(允许这些子表达式作为一个组被包含，排除，排列等) |
| ~          | 取消一个词的排序值                                           |
| *          | 词尾的通配符                                                 |
| " "        | 定义一个短语(与单个词的列表不一样，它匹配整个短语以便包含或排除这个短语) |

#### 18.2.5.全文本搜索的使用说明

给出全文本搜索的某些重要的说明。

1.在索引全文本数据时，短词被忽略且从索引中排除。短词定义为那些具有3个或3个以下字符的词(如果需要，这个数目可以更改)。

2.MySQL带有一个内建的非用词(stopword)列表，这些词在索引全文本数据时总是被忽略、如果需要，可以覆盖这个列表(请参考MySQL文档以了解如何完成此工作)。

3.许多词出现的频率很高，搜索它们没有用处。

4.如果表中的行数小于3行，则全文本搜索不返回结果

5.不具有词分隔符(包括日语和汉语)的语言不能恰当地返回全文本搜索结果。

6.如前所述，仅在MyISAM数据库引擎中支持全文本搜索。
