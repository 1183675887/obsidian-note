---
title: MySQL必知必会10-14章
date: 2020-08-15 11:21:40
tags:
  - MySQL
  - MYSQL必知必会
---

这些章讲解创建计算字段，使用数据处理函数，汇总数据，分组数据，使用子查询。

<!--more-->

## 第十三章，分组数据

分组允许把数据分成多个逻辑组，以便能对每个组进行聚集计算。

### 13.2.创建分组

分组是在SELECT语句的GROUP BY子句中建立的。理解分组的最好办法是看一个例子。

```mysql
输入： SELECT vend_id, COUNT(*)  AS num_prods
      FROM  products
      GROUP BY vend_id;
```

输出：

| vend_id | num_prods |
| ------- | --------- |
| 1001    | 3         |
| 1002    | 2         |
| 1003    | 7         |
| 1004    | 2         |

分析：上面的SELECT语句指定了两个列，vend_id包含产品供应商的ID，num_prods为计算字段(用COUN(*)函数建立)。GROUP BY 子句指示MySQLan按vend_id排序并分组数据。这导致对每个vend_id而不是整个表计算num_prods一次。因为使用了GROUP BY，就不必指定要计算和估值的每个组了。系统会自动完成。GROUP BY子句指示MySQL分组数据。然后对每个组而不是整个结果集进行聚集。

在具体使用GROUP BY之前，需要知道一些重要的规定。

1.GROUP BY子句可以包含任意数目的列。这使得能对分组进行嵌套，为数据分组提供更细致的控制。

2.如果在GROUP BY子句中嵌套了分组，数据将在最后规定的分组上进行汇总。换句话说，在建立分组时，指定的所有列都一起计算(所有不能从个别的列取回数据)。

3.GROUP BY子句中列出的每个列都必须是检索列或有效的表达式(但不能是聚集函数)，换句话说，在建立分组时，指定的所有列都一起计算(所以不能从个别的列取回数据)。

4.除聚集计算语句外，SELECT语句中的每个列都必须在GROUP BY子句中给出。

5.GROUP BY子句必须出现在WHERE子句之后，ORDER BY子句之前。

### 13.3.过滤分组

除了能用GROUP BY分组数据外，MySQL还允许过滤分组，规定包括哪些分组，排除哪些分组。例如，想要列出至少有两个订单的所有顾客。为得出这种数据，必须基于完整的分组而不是个别的行进行过滤。这时候就可以使用HAVING子句了。HAVING子句与WHERE子句很类似，唯一的差别是WHERE过滤行，HAVING过滤分组。

那么怎么过滤分组呢，看下面的例子。

```mysql
输入： SELECT vend_id, COUNT(*)  AS orders
      FROM  products
      GROUP BY vend_id;
      HAVING COUNT(*) >=2;
```

输出：

| vend_id | orders |
| ------- | ------ |
| 10001   | 2      |

分析：这条语句与之前类似，指示最后一行的HAVING子句过滤COUNT(*)>=2的那些分组。只会显示>==2的分组。

**HAVING和WHERE的差别：这里有另一种理解方法，WHERE在数据分组前进行过滤，HAVING在数据分组后进行过滤。**

当然，可以同时使用WHERE和HAVING子句，例如如下例子，它列出具有2个(含)以上，价格为10(含)以上的产品的供应商。

```mysql
输入： SELECT vend_id, COUNT(*)  AS num_prodes
      FROM  products
      WHERE prod_price >= 10
      GROUP BY vend_id;
      HAVING COUNT(*) >=2;
```

输出：

| vend_id | num_prodes |
| ------- | ---------- |
| 1003    | 4          |
| 1005    | 2          |

分析：WHERE先过滤，再按vend_id分组数据，之后HAVING再过滤。

### 13.4.分组和排序

虽然GROUP BY 和ORDER BY经常完成相同的工作，但它们是非常不同的。

| ORDER BY                                   | GROUP BY                                                 |
| ------------------------------------------ | -------------------------------------------------------- |
| 排序产生的输出                             | 分组行，但输出可能不是分组的顺序                         |
| 任意列都可以使用(甚至非选择的列也可以使用) | 只可能使用选择列或表达式列，而且必须使用每个选择列表达式 |
| 不一定需要                                 | 如果与聚焦函数一起使用(或表达式)，则必须使用             |

**不要忘记ORDER BY：一般在使用GROUP子句时，应该也给出ORDER BY子句。这是保证数据正确排序的唯一方法。千万不要依赖GROUP BY排序数据。**

### 13.5.SELECT子句顺序

| 子句     | 说明               | 是否必须使用           |
| -------- | ------------------ | ---------------------- |
| SELECT   | 要返回的列或表达式 | 是                     |
| FROM     | 从中检索数据的表   | 仅在从表选择数据时使用 |
| WHERE    | 行级过滤           | 否                     |
| GROUP BY | 分组说明           | 仅在按组计算聚集时使用 |
| HAVING   | 组级过滤           | 否                     |
| ORDER BY | 输出排序顺序       | 否                     |
| LIMIT    | 要检索的行数       | 否                     |
